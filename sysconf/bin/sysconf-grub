#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of grub
##
##  Use:    source sysconf-grub
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    grubWithoutUsb=$major.$minor;

    minor=$((minor+1));
    grubNoProbe=$major.$minor;

    minor=$((minor+1));
    grubNoAcpi=$major.$minor;
}

function grubConf
{
    local major="$1"; shift;
    defineSteps $major;

    local map="/boot/grub/device.map";
    local cfg="/boot/grub/grub.cfg";

    case "$1" in
      ($major | grub)
        listOptions sysconf-grub "$1";
        quit;
        ;;

      ($grubWithoutUsb | grubWithoutUsb)
        step="$grubWithoutUsb grubWithoutUsb";
        note "Regenerate grub boot list without the USB ...";

        DoOrDie sudo rm -f "${map}";
        DoOrDie sudo update-grub;

        local file;
        for file in "${cfg}" "${map}"; do
            if [[ -e ${file} ]]; then
                DoOrDie cp -pf "${file}" "keep${file}.nousb";
            fi
        done
        ;;

      ($grubNoProbe | grubNoProbe)
        step="$grubNoProbe grubNoProbe";
        note "Regenerate grub boot list without hard drive ...";

        DoOrDie CopyToKeep /etc/grub.d/30_os-prober;
        DoOrDie InstallOurOwn /etc/grub.d/30_os-prober;

        DoOrDie sudo rm "${map}";
        DoOrDie sudo update-grub;
        ;;

      ($grubNoAcpi | grubNoAcpi)
        step="$grubNoAcpi grubNoAcpi";
        note "Regenerate grub boot list with acpi=off ...";

        DoOrDie CopyToKeep /etc/default/grub;
        DoOrDie ApplyPatch /etc/default/grub;

        DoOrDie sudo update-grub;

        DoOrDie cp -pf "${cfg}" "keep${cfg}.noacpi";
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking grub ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            case "$installDist $name" in
              (*grubWithoutUsb)
                CheckOriginal --nousb "${cfg}" "${map}";
                ;;
              (*grubNoProbe)
                CheckOriginal /etc/grub.d/30_os-prober;
                CheckOurOwn /etc/grub.d/30_os-prober;
                ;;
              (*grubNoAcpi)
                CheckOriginal /etc/default/grub;
                CheckPatch /etc/default/grub;
                CheckOriginal --noacpi "${cfg}";
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-grub $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
