#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of block devices
##
##  Use:    source sysconf-blkdev
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    blkdevInstallTools=$major.$minor;

    minor=$((minor+1));
    blkdevMedia=$major.$minor;

    minor=$((minor+1));
    blkdevOpt=$major.$minor;

    minor=$((minor+1));
    blkdevLabels=$major.$minor;

    minor=$((minor+1));
    blkdevSwap=$major.$minor;

    minor=$((minor+1));
    blkdevResume=$major.$minor;

    minor=$((minor+1));
    blkdevFstab=$major.$minor;

    minor=$((minor+1));
    blkdevRaid=$major.$minor;
}

function labelpartition
{
    local label="$1"; shift;
    local device;

    for device; do
        if [[ -b ${device} ]]; then
            DoOrDie sudo e2label ${device} ${label};
            return;
        fi
    done

    exit 1;
}

function blkdevConf
{
    local major="$1"; shift;
    defineSteps $major;

    case "$1" in
      ($major | blkdev)
        listOptions sysconf-blkdev "$1";
        quit;
        ;;

      ($blkdevInstallTools | blkdevInstallTools)
        step="$blkdevInstallTools blkdevInstallTools";
        note "Ensure file system tools are installed";

        installPackage ntfs-3g jfsutils;
        ;;

      ($blkdevMedia | blkdevMedia)
        step="$blkdevMedia blkdevMedia";
        note "Rearrange CD/DVD mount points ...";

        cd /media > /dev/null;

            if [[ -h floppy ]]; then
                DoOrDie sudo rm -f floppy;
                DoOrDie sudo mv -f floppy0 floppy;
            fi

            case "${HOSTNAME}" in
              (alder | birch | olive)
                if [[ -d cdrom0 ]]; then
                    DoOrDie sudo rm -f cdrom;
                    DoOrDie sudo mv -f cdrom0 cdrom;
                fi
                if [[ -d cdrom1 ]]; then
                    DoOrDie sudo mv -f cdrom1 dvd;
                fi
                ;;
              (*)
                if [[ -d cdrom0 ]]; then
                    DoOrDie sudo rm -f cdrom;
                    DoOrDie sudo mv -f cdrom0 cdrom;
                fi
                if [[ -d cdrom ]]; then
                    DoOrDie sudo mv -f cdrom dvd;
                    DoOrDie sudo ln -sf dvd/ cdrom;
                fi

                ;;
            esac

            if [[ -e usb ]]; then
                DoOrDie sudo rm usb;
                DoOrDie sudo rmdir usb*;
            fi

        cd - > /dev/null;
        ;;

      ($blkdevOpt | blkdevOpt)
        step="$blkdevOpt blkdevOpt";
        note "Ensure all can use /opt";

        DoOrDie sudo mount -a;

        if [[ -b /dev/md5 ]]; then
            if ! ls -l /dev/mapper | fgrep -q fstab_opt; then
                DoOrDie sudo ~/bin/volume create fstab opt 2G;
            fi
            if ! mountpoint /opt > /dev/null; then
                DoOrDie sudo mount "/dev/mapper/${HOSTNAME}-fstab_opt" /opt;
            fi
        fi

        DoOrDie sudo chown root:sudo /opt;
        DoOrDie sudo chmod g+w /opt;
        ;;

      ($blkdevLabels | blkdevLabels)
        step="$blkdevLabels blkdevLabels";
        note "Apply labels to standard partitions ...";

        labelpartition root /dev/md1 /dev/sda5;
        labelpartition home /dev/md2 /dev/sda6;
        labelpartition usr  /dev/md3 /dev/sda7;
        labelpartition var  /dev/md4 /dev/sda8;
        labelpartition opt  "/dev/mapper/${HOSTNAME}-fstab_opt" /dev/sda9;
        ;;

      ($blkdevSwap | blkdevSwap)
        step="$blkdevSwap blkdevSwap";
        note "Label active swap partitions ...";

        DoOrDie sudo swapon --summary > /tmp/labelswap || exit 1;
        sed -i /tmp/labelswap \
            -e '1d' -e 's/ .*//' -e 's/.*/sudo swaplabel -L & &/' \
            -e 's~/dev/sd\(.\).~swap\1~' \
            -e 's~/dev/mapper[^_]*_~~'

        local line;
        while read line; do
           echo "   " "${line}";
           DoOrDie sudo ${line} || exit 1;
        done < /tmp/labelswap
        ;;

      ($blkdevResume | blkdevResume)
        step="$blkdevResume blkdevResume";
        note "Change resume to use swap label not the uuid ...";

        DoOrDie CopyToKeep /etc/initramfs-tools/conf.d/resume;
        DoOrDie InstallOurOwn /etc/initramfs-tools/conf.d/resume;
        DoOrDie sudo update-initramfs -u;
        ;;

      ($blkdevFstab | blkdevFstab)
        step="$blkdevFstab blkdevFstab";
        note "Change fstab to use labels not the uuids ...";

        DoOrDie CopyToKeep /etc/fstab;
        DoOrDie FetchOurOwn /etc/fstab;

        local keep="keep/etc/fstab";
        local label, device, mp;

        for label in swapa swapb; do
            if [[ ! -h "/dev/disk/by-label/${label}" ]]; then
                DoOrDie sed -i "${keep}" -e "'/${label}/d'";
            fi
        done
        for label in crypt; do
            if [[ ! -e "/dev/md0" ]]; then
                DoOrDie sed -i "${keep}" -e "'/${label}/d'";
            fi
        done
        for device in fd0 sr0 sr1; do
            if [[ ! -e "/dev/${device}" ]]; then
                DoOrDie sed -i "${keep}" -e "'/${device}/d'";
            fi
        done
        for mp in /opt; do
            if fgrep -q "${mp} xfs" /etc/mtab; then
                DoOrDie sed -i "${keep}" -e "'/\\/${mp}/s/ext4/xfs /'";
            fi
        done

        DoOrDie Deploy /etc/fstab;

        note "Check this and amend by hand if necessary before going any further";
        cat /etc/fstab;
        ;;

      ($blkdevRaid | blkdevRaid)
        step="$blkdevRaid blkdevRaid";
        note "Backup the RAID configuration ...";

        DoOrDie CopyToKeep /etc/mdadm/mdadm.conf;
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking blkdev ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            case "$installDist $name" in
              (*blkdevInstallTools)
                CheckCurrent /etc/{passwd,group};
                ;;
              (*blkdevMedia)
                (DoOrDie ls -ld /media/fd* /media/cd* /media/dvd* /media/usb* 2> /dev/null);
                ;;
              (*blkdevOpt)
                ;;
              (*blkdevLabels)
                (cd /dev/disk/by-label && ls -ld root home usr var opt);
                ;;
              (*blkdevSwap)
                (cd /dev/disk/by-label && ls -ld swap*);
                ;;
              (*blkdevResume)
                CheckOriginal /etc/initramfs-tools/conf.d/resume;
                CheckOurOwn /etc/initramfs-tools/conf.d/resume;
                ;;
              (*blkdevFstab)
                CheckOriginal /etc/fstab;
                CheckDeployed /etc/fstab;
                ;;
              (*blkdevRaid)
                CheckOriginal /etc/mdadm/mdadm.conf;
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-blkdev $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
