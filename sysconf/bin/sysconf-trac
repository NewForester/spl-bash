#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of trac software
##
##  Use:    source sysconf-trac
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    tracInstall=$major.$minor;

    minor=$((minor+1));
    tracConfigure=$major.$minor;

    minor=$((minor+1));
    tracUsers=$major.$minor;

    minor=$((minor+1));
    tracDisable=$major.$minor.D;
    tracEnable=$major.$minor.E;

    minor=$((minor+1));
    tracCreate=$major.$minor.C;
    tracRestore=$major.$minor.R;
    tracCreateCheck=$major.$minor.T;

    minor=$((minor+1));
    tracPermissions=$major.$minor;
    tracPermissionsCheck=$major.$minor.T;

    minor=$((minor+1));
    tracIniFile=$major.$minor;
    tracPluginBlog=$major.$minor.B;
    tracPluginChild=$major.$minor.C;

    minor=$((minor+1));
    tracComponentEnums=$major.$minor;
}

function checkEnvironment
{
    if [[ -z "${env}" ]]; then
        note "Bailing ... try sysconf ${step} <trac-environment-name>";
        quit;
    fi

    tracDir="${tracRoot}/${env}";

    if [[ -d "${tracDir}" ]]; then
        if [[ $# -eq 2 ]]; then
            note "Bailing ... trac environment ${env} already exists";
            quit;
        fi
    else
        if [[ $# -eq 1 ]]; then
            note "Bailing ... trac environment ${env} does not exist";
            quit;
        fi
    fi
}

function echoInstructions
{
    echo "Start standalone server ...";
    echo "... try http://localhost:8081 in your browser";
    echo "... $1";
    echo "... use ^C to kill and continue when ready";
}

function tracConf
{
    local tracRoot="/media/work/www-data/trac";

    local major="$1"; shift;
    defineSteps $major;

    step="$1";
    local env="$2";

    case "$1" in
      ($major | trac)
        listOptions sysconf-trac "$1";
        quit;
        ;;

      ($tracInstall | tracInstall)
        step="$tracInstall tracInstall";
        note "Install trac packages ...";

        installPackage trac;
        ;;

      ($tracConfigure | tracConfigure)
        step="$tracConfigure tracConfigure";
        note "Configure the trac package ...";

        if [[ ! -b "/dev/${HOSTNAME}/work_www-data" ]]; then
            note "www volume does not exist ... bailing";
            quit 1;
        fi

        DoOrDie sudo -u www-data mkdir -p "${tracRoot}";
        DoOrDie sudo -u www-data chmod g+w "${tracRoot}";

        DoOrDie InstallOurOwn /etc/init.d/trac;
        DoOrDie sudo update-rc.d trac defaults;
        ;;

      ($tracUsers | tracUsers)
        step="$tracUsers tracUsers";
        note "Create/update trac users and their passwords ...";

        if [[ -e "${tracRoot}/.htpasswd" ]]; then
            echo "Update authentication file ...";
            echo "";
            cat "${tracRoot}/.htpasswd";
            echo "";
        else
            echo "Create authentication file ...";
        fi
        DoOrDie touch "${tracRoot}/.htpasswd";

        echo "... paste password entries into this console and press ^D when done ...";
        echo "... for new entries, use http://aspirine.org/htpasswd_en.html ...";
        echo "    ... don't choose passwords containing : or ; or . or ,";

        echo "------------------------------------------------";
        cat > "${tracRoot}/.htpasswd";
        echo "------------------------------------------------";
        ;;

      ($tracDisable | tracDisable)
        step="$tracDisable tracDisable";
        note "Disable trac standalone server ...";

        DoOrDie sudo invoke-rc.d trac stop;
        DoOrDie sudo update-rc.d trac disable;
        ;;

      ($tracEnable | tracEnable)
        step="$tracEnable tracEnable";
        note "Enable trac standalone server ...";

        DoOrDie sudo update-rc.d trac enable;
        DoOrDie sudo invoke-rc.d trac start;
        ;;

      ($tracCreate | tracCreate)
        checkEnvironment is new;
        step="$tracCreate tracCreate:${env}";
        note "Create new trac environment ${env^} ...";

        DoOrDie sudo -u www-data mkdir -p "${tracDir}";
        DoOrDie sudo -u www-data trac-admin "${tracDir}" initenv "${env^}" "sqlite:db/trac.db" > /dev/null;

        DoOrDie sudo -u www-data chmod -R g+r "${tracDir}";
        DoOrDie sudo -u www-data chmod g+w "${tracDir}/conf";

        DoOrDie cp -pf "${tracDir}/conf/"trac.ini{,.kkk};
        ;;

      ($tracRestore | tracRestore)
        checkEnvironment is new;
        step="$tracRestore tracRestore:${env}";
        note "Restore trac environment ${env^} from backup ...";

        local backup="/media/share/backup/current/wiki-trac-${env}.tgz";
        DoOrDie sudo -u www-data tar -xzf "${backup}" -C "${tracRoot}";

        DoOrDie sudo -u www-data chmod -R g+r "${tracDir}";
        DoOrDie sudo -u www-data chmod g+w "${tracDir}/conf";

        DoOrDie cp -pf "${tracDir}/conf/"trac.ini{,.kkk};

        DoOrDie sudo -u www-data trac-admin "${tracDir}" upgrade;
        DoOrDie sudo -u www-data trac-admin "${tracDir}" wiki upgrade;
        ;;

      ($tracCreateCheck | tracCreateCheck)
        checkEnvironment exists;
        step="$tracCreateCheck tracCreateCheck:${env}";
        note "Check trac environment ${env^} created/restored ...";

        echoInstructions "try browsing the help pages - you can't login in or enter any data yet";
        DoOrDie sudo -u www-data PKG_RESOURCES_CACHE_ZIP_MANIFESTS=1 tracd --port=8081 -s "${tracDir}";
        ;;

      ($tracPermissions | tracPermissions)
        checkEnvironment exists;
        step="$tracPermissions tracPermissions:${env}";
        note "Add/update permissions for trac environment ${env^} ...";

        DoOrDie sudo -u www-data trac-admin "${tracDir}" permission add debian TRAC_ADMIN WIKI_ADMIN;
        DoOrDie sudo -u www-data trac-admin "${tracDir}" permission add authenticated TICKET_EDIT_DESCRIPTION WIKI_RENAME;
        ;;

      ($tracPermissionsCheck | tracPermissionsCheck)
        checkEnvironment exists;
        step="$tracPermissionsCheck tracPermissionsCheck:${env}";
        note "Check permissions of trac environment ${env^} ...";

        echoInstructions "try to login as debian and check users and permissions";
        DoOrDie sudo -u www-data tracd --port=8081 -s --basic-auth="*,${tracRoot}/.htpasswd,trac" "${tracDir}";
        ;;

      ($tracIniFile | tracIniFile)
        checkEnvironment exists;
        step="$tracIniFile tracIniFile:${env}";
        note "Revise trac.ini of trac environment ${env^} ...";

# trac-admin config get <section> <option>
# trac-admin config set <section> <option> <value>

        DoOrDie cp -p "${tracDir}/conf/trac.ini" "/tmp/trac.ini.$$";

        sed -e '/^\[components]/,/^$/d' -e '/^\[components]/,$d' -i "/tmp/trac.ini.$$";
        cat >> "/tmp/trac.ini.$$" << EOF
[components]
trac.ticket.report.* = disabled
EOF
        sed -e "/alt =/s/=.*/= ${env^}/" -e "/src =/s/=.*/= site\/${env}.png/" -i "/tmp/trac.ini.$$";
        sed -e '/default.*query/s/$/\&order=milestone\&group=component/' -i "/tmp/trac.ini.$$";
        sed -e '/^\[intertrac]/,/^$/d' -e '/^\[intertrac]/,$d' -i "/tmp/trac.ini.$$";
        sed -e '/^\[intertrac]/,/^$/p;d' -e '/^\[intertrac]/,$p;d' -e d \
            "${tracDir}/conf/trac.ini" >> "/tmp/trac.ini.$$";
        sed -e '/^\[logging]/,/^$/d' -e '/^\[logging]/,$d' -i "/tmp/trac.ini.$$";
        sed -e '/^\[logging]/,/^$/p;d' -e '/^\[logging]/,$p;d' -e d \
            "${tracDir}/conf/trac.ini" >> "/tmp/trac.ini.$$";

        DoOrDie inisort "/tmp/trac.ini.$$" > "/tmp/${env}.ini.$$";
        nano "/tmp/${env}.ini.$$";
        DoOrDie sudo -u www-data cp -p "/tmp/${env}.ini.$$" "${tracDir}/conf/trac.ini";

        # DoOrDie sudo -u www-data diff -Naur "${tracDir}/conf/trac.ini{.kkk,}";
        ;;

      ($tracPluginBlog | tracPluginBlog)
        checkEnvironment exists;
        step="$tracPluginBlog tracPluginBlog:${env}";
        note "Add the blog plugin to trac environment ${env^} ...";

        DoOrDie cp -p "${tracDir}/conf/trac.ini" "/tmp/trac.ini.$$";
        sed -e '/^\[components]/a\
tracfullblog.* = enabled' -i "/tmp/trac.ini.$$";
        sed -e "/mainnav =/s/= \(.*\)/= blog,\1/" -i "/tmp/trac.ini.$$";
        sed -e '/^\[fullblog]/,/^$/d' -e '/^\[fullblog]/,$d' -i "/tmp/trac.ini.$$";
        sed -e '/^\[fullblog]/,/^$/p;d' -e '/^\[fullblog]/,$p;d' -e d \
            "${tracDir}/conf/trac.ini" >> "/tmp/trac.ini.$$";

        DoOrDie inisort "/tmp/trac.ini.$$" > "/tmp/${env}.ini.$$";
        DoOrDie sudo -u www-data cp -p "/tmp/${env}.ini.$$" "${tracDir}/conf/trac.ini";

        DoOrDie sudo -u www-data trac-admin "${tracDir}" upgrade;

        DoOrDie sudo -u www-data trac-admin "${tracDir}" permission add debian BLOG_ADMIN;
        DoOrDie sudo -u www-data trac-admin "${tracDir}" permission add anonymous BLOG_VIEW;
        DoOrDie sudo -u www-data trac-admin "${tracDir}" permission add authenticated BLOG_COMMENT BLOG_CREATE BLOG_MODIFY_OWN;

        # DoOrDie sudo -u www-data diff -Naur "${tracDir}/conf/trac.ini{.kkk,}";
        ;;

      ($tracPluginChild | tracPluginChild)
        checkEnvironment exists;
        step="$tracPluginChild tracPluginChild:${env}";
        note "Add child tickets to trac environment ${env^} ...";

        DoOrDie cp -p "${tracDir}/conf/trac.ini" "/tmp/trac.ini.$$";
        sed -e '/^\[components]/a\
childtickets.* = enabled' -i "/tmp/trac.ini.$$";
        sed -e '/^\[childtickets]/,/^$/d' -e '/^\[childtickets]/,$d' -i "/tmp/trac.ini.$$";
        sed -e '/^\[childtickets]/,/^$/p;d' -e '/^\[childtickets]/,$p;d' -e d \
            "${tracDir}/conf/trac.ini" >> "/tmp/trac.ini.$$";
        sed -e '/^\[ticket-custom]/,/^$/d' -e '/^\[ticket-custom]/,$d' -i "/tmp/trac.ini.$$";
        sed -e '/^\[ticket-custom]/,/^$/p;d' -e '/^\[ticket-custom]/,$p;d' -e d \
            "${tracDir}/conf/trac.ini" >> "/tmp/trac.ini.$$";

        DoOrDie inisort "/tmp/trac.ini.$$" > "/tmp/${env}.ini.$$";
        DoOrDie sudo -u www-data cp -p "/tmp/${env}.ini.$$" "${tracDir}/conf/trac.ini";

        # DoOrDie sudo -u www-data diff -Naur "${tracDir}/conf/trac.ini{.kkk,}";
        ;;

      ($tracComponentEnums | tracComponentEnums)
        checkEnvironment exists;
        step="$tracComponentEnums tracComponentEnums:${env}";
        note "Revise component enumerations of trac environment ${env^} ...";

        DoOrDie rm -f "/tmp/${env}.db.$$";
        DoOrDie cp -p "${tracDir}/db/trac.db" "/tmp/${env}.db.$$";

        sqlite3 "/tmp/${env}.db.$$" << EOF
.output /tmp/${env}.sql.$$
.dump enum
.dump component
.exit
EOF
        sed -e '/CREATE/h;s/CREATE \(.*\) (/DROP \1;/p' -e '/DROP/g' -i "/tmp/${env}.sql.$$";
        nano "/tmp/${env}.sql.$$";
        DoOrDie cp -p "${tracDir}/db/trac.db" "/tmp/${env}.db.$$";
        sqlite3 "/tmp/${env}.db.$$" < "/tmp/${env}.sql.$$";

        DoOrDie sudo -u www-data cp -p "/tmp/${env}.db.$$" "${tracDir}/db/trac.db";
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking trac ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            case "$installDist $name" in
              (*tracInstall)
                CheckCurrent /etc/{group,passwd};
                ;;
              (*tracConfigure)
                CheckOurOwn /etc/init.d/trac;
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-trac $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
