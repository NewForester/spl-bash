#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of openvpn
##
##  Use:    source sysconf-vpn
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    vpnInstall=$major.$minor;

    minor=$((minor+1));
    vpnConfigure=$major.$minor;

    minor=$((minor+1));
    vpnNoAutostart=$major.$minor;

    minor=$((minor+1));
    vpnHosts=$major.$minor;

    minor=$((minor+1));
    vpnHostsAllow=$major.$minor;

    minor=10;
    vpnNexsan=$major.$minor;
}

function vpnConf
{
    local major="$1"; shift;
    defineSteps $major;

    case "$1" in
      ($major | vpn)
        listOptions sysconf-vpn "$1";
        quit;
        ;;

      ($vpnInstall | vpnInstall)
        step="$vpnInstall vpnInstall";
        note "Install openvpn ...";

        installPackage openvpn;
        ;;

      ($vpnConfigure | vpnConfigure)
        step="$vpnConfigure vpnConfigure";
        note "Install host specific keys, certificates and configuration ...";

        DoOrDie InstallOurOwn /etc/openvpn/ca.crt;

        local vpnhost;
        case "${HOSTNAME}" in
          (ebony)
            host=custards;
            DoOrDie InstallOurOwn /etc/openvpn/dh1024.pem;
            DoOrDie InstallOurOwn --sudo /etc/openvpn/ca.key;
            ;;
          (maple)
            host=maple;
            ;;
          (uk694715dl)
            host=work;
            ;;
          (*)
            host=clifford;
            ;;
        esac

        DoOrDie InstallOurOwn /etc/openvpn/${host}.{conf,crt};
        DoOrDie InstallOurOwn --sudo /etc/openvpn/${host}.key;
        ;;

      ($vpnNoAutostart | vpnNoAutostart)
        step="$vpnNoAutostart vpnNoAutostart";
        note "Do not start the VPN client automatically ...";

        DoOrDie CopyToKeep /etc/default/openvpn;
        DoOrDie ApplyPatch /etc/default/openvpn;
        ;;

      ($vpnHosts | vpnHosts)
        step="$vpnHosts vpnHosts";
        note "Patch /etc/hosts with VPN host names ...";

        echo "... update /etc/hosts";
        DoOrDie CopyToKeep /etc/hosts;
        DoOrDie InsertIntoFile '2' /etc/hosts hosts-vpn;

        if [[ $(fgrep -c ${HOSTNAME} keep/etc/hosts) -gt 1 ]]; then
            DoOrDie -i keep/etc/hosts sed -e "'2d'";
        fi

        DoOrDie Deploy /etc/hosts;
        ;;

      ($vpnHostsAllow | vpnHostsAllow)
        step="$vpnHostsAllow vpnHostsAllow";
        note "Update /etc/hosts.allow to allow services over the VPN ...";

        echo "... update /etc/hosts.allow";
        DoOrDie CopyToKeep /etc/hosts.allow;
        DoOrDie InsertIntoFile '/localhost/' /etc/hosts.allow hosts.allow-{ssh,nfs}-vpn;
        DoOrDie Deploy /etc/hosts.allow;
        ;;

      ($vpnNexsan | vpnNexsan)
        step="$vpnNexsan vpnNexsan";
        note "Install ppp files needed for Nexsan VPNs ...";

        DoOrDie InstallOurOwn /etc/ppp/peers/{nexsan-pptp,nexsan-sstp};
        DoOrDie InstallOurOwn /etc/ppp/ip-up.d/nexsan-vpn;

        DoOrDie CopyToKeep --sudo /etc/ppp/chap-secrets;
        DoOrDie ApplyPatch --sudo /etc/ppp/chap-secrets chap-secrets-nexsan;
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking vpn ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            case "$installDist $name" in
              (*vpnInstall)
                CheckCurrent /etc/{group,passwd};
                ;;
              (*vpnConfigure)
                CheckOurOwn /etc/openvpn/ca.crt;

                local vpnhost;
                case "${HOSTNAME}" in
                  (ebony)
                    host=custards;
                    CheckOurOwn /etc/openvpn/dh1024.pem;
                    CheckOurOwn --sudo /etc/openvpn/ca.key;
                    ;;
                  (maple)
                    host=maple;
                    ;;
                  (uk694715dl)
                    host=work;
                    ;;
                  (*)
                    host=clifford;
                    ;;
                esac

                CheckOurOwn /etc/openvpn/${host}.{conf,crt};
                CheckOurOwn --sudo /etc/openvpn/${host}.key;
                ;;
              (*vpnNoAutostart)
                CheckOriginal /etc/default/openvpn;
                CheckPatch /etc/default/openvpn;
                ;;
              (*vpnHosts)
                CheckOriginal /etc/hosts;
                CheckDotDir /etc/hosts hosts-vpn;
                ;;
              (*vpnHostsAllow)
                CheckOriginal /etc/hosts.allow;
                CheckDotDir /etc/hosts.allow hosts.allow-{ssh,nfs}-vpn;
                ;;
              (*vpnNexsan)
                CheckOurOwn /etc/ppp/peers/{nexsan-pptp,nexsan-sstp};
                CheckOurOwn /etc/ppp/ip-up.d/nexsan-vpn;

                CheckOriginal --sudo /etc/ppp/chap-secrets;
                CheckPatch --sudo /etc/ppp/chap-secrets chap-secrets-nexsan;
                ;;

            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-vpn $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
