#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of user ids and groups
##
##  Use:    source sysconf-user
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    userConf=$major.$minor;

    minor=$((minor+1));
    userGroups=$major.$minor;

    minor=$((minor+1));
    userAdd=$major.$minor;

    minor=$((minor+1));
    userMozilla=$major.$minor;

    minor=$((minor+1));
    userSudoers=$major.$minor;

    minor=$((minor+1));
    userMozillaExtensions=$major.$minor;
    userMasterExtensions=$major.$minor.M;
}

function userConf
{
    local major="$1"; shift;
    defineSteps $major;

    case "$1" in
      ($major | user)
        listOptions sysconf-user "$1";
        quit;
        ;;

      ($userConf | userConf)
        step="$userConf userConf";
        note "Backup and patch adduser.conf ...";

        DoOrDie CopyToKeep /etc/adduser.conf;
        DoOrDie ApplyPatch /etc/adduser.conf;
        ;;

      ($userGroups | userGroups)
        step="$userGroups userGroups";
        note "Create and destroy groups ...";

        DoOrDie SaveCurrent /etc/group;

        fgrep -q "${USER}:" /etc/group && DoOrDie sudo delgroup "${USER}";
        fgrep -q "work:" /etc/group || DoOrDie sudo addgroup work;
        fgrep -q "philately:" /etc/group || DoOrDie sudo addgroup philately;

        echo "... adjust group membership for default user ...";
        delUserFromGroups "${USER}" bluetooth dip plugdev scanner;

        source /etc/adduser.conf;
        addUserToGroups "${USER}" adm ${EXTRA_GROUPS};

        DoOrDie SaveCurrent /etc/group;
        ;;

      ($userAdd | userAdd)
        step="$userAdd userAdd";
        note "Create additional users ...";

        DoOrDie SaveCurrent /etc/{group,passwd};

        if fgrep -q QEMU /proc/cpuinfo; then
            local hostMachine="qemu";
        else
            local hostMachine=$(uname -m);
        fi

        case "${hostMachine}" in
          (x86_64)
            DoOrDie sudo adduser pbr     --uid 1001;
            DoOrDie sudo adduser ber     --uid 1002;
            DoOrDie sudo adduser telly   --uid 1003;
            DoOrDie sudo adduser work    --uid 1004;
            DoOrDie sudo adduser mozilla --uid 1005 --disabled-login;
            ;;
          (i686)
            DoOrDie sudo adduser pbr     --uid 1001;
            DoOrDie sudo adduser ber     --uid 1002;
            DoOrDie sudo adduser telly   --uid 1003 --disabled-login;
            DoOrDie sudo adduser work    --uid 1004 --disabled-login;
            DoOrDie sudo adduser mozilla --uid 1005 --disabled-login;
            ;;
          (qemu)
            DoOrDie sudo adduser pbr     --uid 1001 --disabled-login;
            DoOrDie sudo adduser ber     --uid 1002 --disabled-login;
            DoOrDie sudo adduser telly   --uid 1003 --disabled-login;
            DoOrDie sudo adduser work    --uid 1004;
            DoOrDie sudo adduser mozilla --uid 1005 --disabled-login;
            ;;
          (*)
            error "Processor \"${hostMachine}\" not recognised";
            exit 1;
            ;;
        esac

        DoOrDie SaveCurrent /etc/{group,passwd};
        ;;

      ($userMozilla | userMozilla)
        step="$userMozilla userMozilla";
        note "Populate /home/mozilla for Mozilla applications ...";

        DoOrDie sudo rm -fr /home/mozilla/*;
        DoOrDie sudo chmod g+w /home/mozilla/;

        local app;
        for app in firefox thunderbird; do
            DoOrDie mkdir -p "/home/mozilla/${app}";
            DoOrDie sudo cp -pR "${installShare}/usrconf/${app}/profile" "/home/mozilla/${app}";
        done
        ;;

      ($userSudoers | userSudoers)
        step="$userSudoers userSudoers";
        note "Install sudoers files allowing specials privileges ...";

        DoOrDie InstallOurOwn /etc/sudoers.d/backup;
        ;;

      ($userMozillaExtensions | userMozillaExtensions)
        step="$userMozillaExtensions userMozillaExtensions";
        note "Update Mozilla extensions, adblockplus and plug-ins ...";

        local app;
        for app in firefox thunderbird; do
            DoOrDie rsync -ax --delete "/media/share/linux/usrconf/${app}/profile" "/home/mozilla/${app}";
            if [[ -d "/media/share/linux/usrconf/${app}/${HOSTNAME}" ]]; then
                DoOrDie rsync -ax "/media/share/linux/usrconf/${app}/${HOSTNAME}/*" "/home/mozilla/${app}/profile";
            fi
        done
        ;;

      ($userMasterExtensions | userMasterExtensions)
        step="$userMasterExtensions userMasterExtensions";
        note "Update master Mozilla profile (extensions, adblockplus etc.) ...";

        local app;
        for app in firefox thunderbird; do
            DoOrDie sudo chmod -R g+r "/home/mozilla/${app}/profile";
            DoOrDieLocal touchdir -r "/home/mozilla/${app}/profile";
            DoOrDie rsync -ax --delete "/home/mozilla/${app}/profile" "/media/share/linux/usrconf/${app}";
        done
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking user ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            case "$installDist $name" in
              (*userConf)
                status="\e[31mFIXME\e[0m";
                CheckOriginal /etc/adduser.conf;
                CheckPatch /etc/adduser.conf;
                ;;
              (*userGroups)
                CheckCurrent /etc/{group,passwd};
                ;;
              (*userAdd)
                CheckCurrent /etc/{group,passwd};
                grep 'x:10..:100:' /etc/passwd;
                ;;
              (*userSudoers)
                CheckOurOwn --sudo /etc/sudoers.d/backup;
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-user $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
