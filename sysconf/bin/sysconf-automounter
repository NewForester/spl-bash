#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of the autmounter
##
##  Use:    source sysconf-automounter
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

# do it

function automounterConf
{
    case "$1" in
      (14 | automounter)
        listOptions 14 automounter;
        quit;
        ;;

      (14.1 | automounterInstall)
        step="14.1 automounterInstall";
        note "Install the automounter ...";

        installPackage autofs;
        ;;

      (14.2 | automounterConfigure)
        step="14.2 automounterConfigure";
        note "Configure the autmounter ...";

        echo "... add our own maps and script";
        DoOrDie sudo rm -f /etc/auto.master.d/*;
        DoOrDie InstallOurOwn /etc/auto.master.d/{net.autofs,automount.logical.volumes,nfs-servers-by-subnet};

        DoOrDie sudo service autofs stop;
        fgrep -q "${installShare} " /etc/mtab && DoOrDie sudo umount "${installShare}";

        local list="share ";
        if [[ -e "/dev/${HOSTNAME##*-}" ]]; then
            list+="local ";
            list+=$(ls -1 "/dev/${HOSTNAME##*-}" | sed -e 's/_.*//' | sort -u);
        else
            case "${HOSTNAME}" in
              (alder | holly | olive)
                list+="win";
                ;;
              (pbr-wheezy)
                list+="win";
                ;;
            esac
        fi

        local group;
        for group in ${list}; do
            DoOrDie sudo ~/bin/volume import ${group};
        done

        DoOrDie sudo service autofs start;

        echo "... add script to flush automounts before entering suspend";
        DoOrDie InstallOurOwn /etc/pm/sleep.d/30-flush-mounts;
        ;;

      (14.99)
        step="14.99 sanityCheck";
        note "Checking automounter ...";
        ListLoggedSteps ${1%.*} | while read step name status; do
            echo -e $step $name $status;
            case "$step $name" in
              ("14.2 automounterConfigure")
                CheckOurOwn /etc/auto.master.d/{net.autofs,automount.logical.volumes,nfs-servers-by-subnet};
                CheckOurOwn /etc/pm/sleep.d/30-flush-mounts;
                (cd /etc/auto.master.d && ls -l auto.*);
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions 14 automounter;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
