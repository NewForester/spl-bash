#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of firmware modules
##
##  Use:    source sysconf-firmware
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    microcodeAmd=$major.$minor.A;
    microcodeIntel=$major.$minor.I;

    minor=$((minor+1));
    firmwareRadeon=$major.$minor;

    minor=$((minor+1));
    firmwareRealtek=$major.$minor.R;
    firmwareLblink=$major.$minor.L;
    firmwareNetgear=$major.$minor.N;
    firmwareBelkin=$major.$minor.B;

    minor=$((minor+1));
    firmwareSdhc=$major.$minor;

    minor=$((minor+1));
    firmwareDvb=$major.$minor;
}

function bewareGrub
{
    error "If this step ran:";
    note  "    update-initramfs: Generating /boot/initrd.img ..";
    error "then it is suggested you run:"
    note  "    sysconf grubDualDisk";
    error "if you have two distinct boot partitions";
}

function firmwareConf
{
    local fwbase=/media/share/linux/firmware;

    local major="$1"; shift;
    defineSteps $major;

    case "$1" in
      ($major | firmware | microcode)
        listOptions sysconf-firmware "$1";
        quit;
        ;;

      ($microcodeAmd | microcodeAmd)
        step="$microcodeAmd microcodeAmd";
        note "Install microcode updates for AMD processors ...";

        installPackage amd64-microcode;
        bewareGrub;
        ;;

      ($microcodeIntel | microcodeIntel)
        step="$microcodeIntel microcodeIntel";
        note "Install microcode updates for Intel processors ...";

        installPackage intel-microcode;
        bewareGrub;
        ;;

      ($firmwareRadeon | firmwareRadeon)
        step="$firmwareRadeon firmwareRadeon";
        note "Install firmware for the Radeon graphic chips ...";

        DoOrDie sudo cp -pR "${fwbase}/radeon" "/lib/firmware/";
        ;;

      ($firmwareRealtek | firmwareRealtek)
        step="$firmwareRealtek firmwareRealtek";
        note "Install firmware for the Realtek network interface chips ...";

        DoOrDie sudo cp -pR "${fwbase}/rtl_nic" "/lib/firmware/";
        ;;

      ($firmwareLblink | firmwareLblink)
        step="$firmwareLblink firmwareLblink";
        note "Install firmware for the LB Link USB wifi stick ...";

        DoOrDie sudo cp -pR "${fwbase}/rtlwifi" "/lib/firmware/";

        echo "... add script to unload/reload the driver module when entering/leaving a suspend mode";
        DoOrDie InstallOurOwn /etc/pm/sleep.d/75-rtlwifi;
        ;;

      ($firmwareNetgear | firmwareNetgear)
        step="$firmwareNetgear firmwareNetgear";
        note "Install firmware for the Netgear PCMCIA wifi card ...";

        DoOrDie sudo cp -pR "${fwbase}/isl3886pci" "/lib/firmware/";

        echo "... add script to unload/reload the driver module when entering/leaving a suspend mode";
        DoOrDie InstallOurOwn /etc/pm/sleep.d/75-prism;
        ;;

      ($firmwareBelkin | firmwareBelkin)
        step="$firmwareBelkin firmwareBelkin";
        note "Install firmware for the Belkin USB wifi stick ...";

        DoOrDie sudo cp -pR "${fwbase}/zd1211" "/lib/firmware/";
        ;;

      ($firmwareSdhc | firmwareSdhc)
        step="$firmwareSdhc firmwareSdhc";
        note "Install firmware for SDHC flash card reader ...";

        DoOrDie sudo cp -pR "${fwbase}/ene-ub6250" "/lib/firmware/";
        ;;

      ($firmwareDvb | firmwareDvb)
        step="$firmwareDvb firmwareDvb";
        note "Install firmware for the USB DVB sticks ...";

        fwbase="/media/work/projects/mythtv/firmware"
        DoOrDie sudo cp -p "${fwbase}/"{dvb-usb-dib0700-1.20.fw,dvb-usb-ec168.fw} "/lib/firmware";
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking firmware ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            local needsTLC="New one this:  sysconf-firmware needs some maintenance ...";
            case "$installDist $name" in
              (*microcodeAmd*)
                CheckCurrent /etc/{passwd,group};
                error "$needsTLC";
                ;;
              (*microcodeIntel*)
                CheckCurrent /etc/{passwd,group};
                error "$needsTLC";
                ;;
              (*firmwareRadeon*)
                error "$needsTLC";
                ;;
              (*firmwareRealtek*)
                error "$needsTLC";
                ;;
              (*firmwareLblink*)
                CheckOurOwn /etc/pm/sleep.d/75-rtlwifi;
                error "$needsTLC";
                ;;
              (*firmwareNetgear*)
                CheckOurOwn /etc/pm/sleep.d/75-prism;
                error "$needsTLC";
                ;;
              (*firmwareBelkin*)
                error "$needsTLC";
                ;;
              (*firmwareSdhc*)
                error "$needsTLC";
                ;;
              (*firmwareDvb*)
                  error "$needsTLC";
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-firmware $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
