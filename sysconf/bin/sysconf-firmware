#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of firmware modules
##
##  Use:    source sysconf-firmware
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    microcodeAmd=$major.$minor.A;
    microcodeIntel=$major.$minor.I;

    minor=$((minor+1));
    firmwareRadeon=$major.$minor;

    minor=$((minor+1));
    firmwareRealtek=$major.$minor.R;
    firmwareLblink=$major.$minor.L;
    firmwareNetgear=$major.$minor.N;
    firmwareBelkin=$major.$minor.B;

    minor=$((minor+1));
    firmwareSdhc=$major.$minor;

    minor=$((minor+1));
    firmwareDvb=$major.$minor;
}

function bewareGrub
{
    error "If this step ran:";
    note  "    update-initramfs: Generating /boot/initrd.img ..";
    error "then it is suggested you run:"
    note  "    sysconf grubDualDisk";
    error "if you have two distinct boot partitions";
}

function srcFirmware
{
    action="$1"; shift;

    for blob; do
        case "${action}" in
          (save)
            DoOrDie cp -pR "${fwdst}/${blob}" "${fwsrc}";
            ;;
          (restore)
            DoOrDie sudo cp -pR "${fwsrc}/${blob}" "${fwdst}";
            ;;
          (check)
            if [[ ! -r "${fwdst}/${blob}" ]]; then
                error "\"${blob}\" firmware has not been installed";
            elif [[ ! -r "${fwsrc}/${blob}" ]]; then
                error "\"${blob}\" firmware has not beed saved";
            else
                diff -q "${fwdst}/${blob}" "${fwsrc}/${blob}";
            fi
            ;;
          (*)
            error "\"${action}\" not recognised: use one of save, restore or check";
            quit 1;
            ;;
        esac
    done
}

function firmwareConf
{
    local fwdst="/lib/firmware";
    local fwsrc="${installShare}/firmware";

    local major="$1"; shift;
    defineSteps $major;

    case "$1" in
      ($major | firmware | microcode)
        listOptions sysconf-firmware "$1";
        quit;
        ;;

      ($microcodeAmd | microcodeAmd)
        step="$microcodeAmd microcodeAmd";
        note "Install microcode updates for AMD processors ...";

        if [[ -n "$2" ]]; then
            step+=":$2";
            srcFirmware "$2" amd-ucode;
        else
            installPackage amd64-microcode;
            bewareGrub;
        fi
        ;;

      ($microcodeIntel | microcodeIntel)
        step="$microcodeIntel microcodeIntel";
        note "Install microcode updates for Intel processors ...";

        if [[ -n "$2" ]]; then
            step+=":$2";
            srcFirmware "$2" intel-ucode;
        else
            installPackage intel-microcode;
            bewareGrub;
        fi
        ;;

      ($firmwareRadeon | firmwareRadeon)
        step="$firmwareRadeon firmwareRadeon";
        note "Install firmware for the Radeon graphic chips ...";

        DoOrDie sudo cp -pR "${fwsrc}/radeon" "${fwdst}";
        ;;

      ($firmwareRealtek | firmwareRealtek)
        step="$firmwareRealtek firmwareRealtek";
        note "Install firmware for the Realtek network interface chips ...";

        DoOrDie sudo cp -pR "${fwsrc}/rtl_nic" "${fwdst}";
        ;;

      ($firmwareLblink | firmwareLblink)
        step="$firmwareLblink firmwareLblink";
        note "Install firmware for the LB Link USB wifi stick ...";

        DoOrDie sudo cp -pR "${fwsrc}/rtlwifi" "${fwdst}";

        echo "... add script to unload/reload the driver module when entering/leaving a suspend mode";
        DoOrDie InstallOurOwn /etc/pm/sleep.d/75-rtlwifi;
        ;;

      ($firmwareNetgear | firmwareNetgear)
        step="$firmwareNetgear firmwareNetgear";
        note "Install firmware for the Netgear PCMCIA wifi card ...";

        DoOrDie sudo cp -pR "${fwsrc}/isl3886pci" "${fwdst}";

        echo "... add script to unload/reload the driver module when entering/leaving a suspend mode";
        DoOrDie InstallOurOwn /etc/pm/sleep.d/75-prism;
        ;;

      ($firmwareBelkin | firmwareBelkin)
        step="$firmwareBelkin firmwareBelkin";
        note "Install firmware for the Belkin USB wifi stick ...";

        DoOrDie sudo cp -pR "${fwsrc}/zd1211" "${fwdst}";
        ;;

      ($firmwareSdhc | firmwareSdhc)
        step="$firmwareSdhc firmwareSdhc";
        note "Install firmware for SDHC flash card reader ...";

        DoOrDie sudo cp -pR "${fwsrc}/ene-ub6250" "${fwdst}";
        ;;

      ($firmwareDvb | firmwareDvb)
        step="$firmwareDvb firmwareDvb";
        note "Install firmware for the USB DVB sticks ...";

        fwsrc="/media/work/projects/mythtv/firmware"
        DoOrDie sudo cp -p "${fwsrc}/"{dvb-usb-dib0700-1.20.fw,dvb-usb-ec168.fw} "${fwdst}";
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking firmware ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            case "$installDist $name" in
              (*microcodeAmd*)
                [[ -n "$microcodeAmd" ]] && srcFirmware check amd-ucode;
                unset microcodeAmd;
                CheckCurrent /etc/{passwd,group};
                ;;
              (*microcodeIntel*)
                [[ -n "$microcodeIntel" ]] && srcFirmware check intel-ucode;
                unset microcodeIntel;
                CheckCurrent /etc/{passwd,group};
                ;;
              (*firmwareRadeon*)
                [[ -n "$firmwareRadeon" ]] && srcFirmware check radeon;
                unset firmwareRadeon;
                ;;
              (*firmwareRealtek*)
                [[ -n "$firmwareRealtek" ]] && srcFirmware check rtl_nic;
                unset firmwareRealtek;
                ;;
              (*firmwareLblink*)
                [[ -n "$firmwareLblink" ]] && srcFirmware check rtlwifi;
                unset firmwareLblink;
                CheckOurOwn /etc/pm/sleep.d/75-rtlwifi;
                ;;
              (*firmwareNetgear*)
                [[ -n "$firmwareNetgear" ]] && srcFirmware check isl3886pci;
                unset firmwareNetgear;
                CheckOurOwn /etc/pm/sleep.d/75-prism;
                ;;
              (*firmwareBelkin*)
                [[ -n "$firmwareBelkin" ]] && srcFirmware check zd1211;
                unset firmwareBelkin;
                ;;
              (*firmwareSdhc*)
                [[ -n "$firmwareSdhc" ]] && srcFirmware check ene-ub6250;
                unset firmwareSdhc;
                ;;
              (*firmwareDvb*)
                fwsrc="/media/work/projects/mythtv/firmware";
                [[ -n "$firmwareDvb" ]] && srcFirmware check {dvb-usb-dib0700-1.20.fw,dvb-usb-ec168.fw};
                unset firmwareDvb;
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-firmware $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
