#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of firmware modules
##
##  Use:    source sysconf-firmware
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    firmwareNetgear=$major.$minor;

    minor=$((minor+1));
    firmwareBelkin=$major.$minor;

    minor=$((minor+1));
    firmwareRtl=$major.$minor;

    minor=$((minor+1));
    firmwareRadeon=$major.$minor;

    minor=$((minor+1));
    firmwareDvb=$major.$minor;

    minor=$((minor+1));
    firmwareSdhc=$major.$minor;

    minor=$((minor+1));
    firmwareLblink=$major.$minor;
}

function firmwareConf
{
    local fwbase=/media/share/linux/firmware;

    local major="$1"; shift;
    defineSteps $major;

    case "$1" in
      ($major | firmware)
        listOptions sysconf-firmware "$1";
        quit;
        ;;

      ($firmwareNetgear | firmwareNetgear)
        step="$firmwareNetgear firmwareNetgear";
        note "Install firmware for the Netgear PCMCIA wifi card ...";

        DoOrDie sudo cp -pR "${fwbase}/isl3886pci" "/lib/firmware/";

        echo "... add script to unload/reload the driver module when entering/leaving a suspend mode";
        DoOrDie InstallOurOwn /etc/pm/sleep.d/75-prism;
        ;;

      ($firmwareBelkin | firmwareBelkin)
        step="$firmwareBelkin firmwareBelkin";
        note "Install firmware for the Belkin USB wifi stick ...";

        DoOrDie sudo cp -pR "${fwbase}/zd1211" "/lib/firmware/";
        ;;

      ($firmwareRtl | firmwareRtl)
        step="$firmwareRtl firmwareRtl";
        note "Install firmware for the RTL network interface chips ...";

        DoOrDie sudo cp -pR "${fwbase}/rtl_nic" "/lib/firmware/";
        ;;

      ($firmwareRadeon | firmwareRadeon)
        step="$firmwareRadeon firmwareRadeon";
        note "Install firmware for the Radeon graphic chips ...";

        DoOrDie sudo cp -pR "${fwbase}/radeon" "/lib/firmware/";
        ;;

      ($firmwareDvb | firmwareDvb)
        step="$firmwareDvb firmwareDvb";
        note "Install firmware for the USB DVB sticks ...";

        fwbase="/media/work/projects/mythtv/firmware"
        DoOrDie sudo cp -p "${fwbase}/"{dvb-usb-dib0700-1.20.fw,dvb-usb-ec168.fw} "/lib/firmware";
        ;;

      ($firmwareSdhc | firmwareSdhc)
        step="$firmwareSdhc firmwareSdhc";
        note "Install firmware for SDHC flash card reader ...";

        DoOrDie sudo cp -pR "${fwbase}/ene-ub6250" "/lib/firmware/";
        ;;

      ($firmwareLblink | firmwareLblink)
        step="$firmwareLblink firmwareLblink";
        note "Install firmware for the LB Link USB wifi stick ...";

        DoOrDie sudo cp -pR "${fwbase}/rtlwifi" "/lib/firmware/";

        echo "... add script to unload/reload the driver module when entering/leaving a suspend mode";
        DoOrDie InstallOurOwn /etc/pm/sleep.d/75-rtlwifi;
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking firmware ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            local needsTLC="New one this:  sysconf-firmware needs some maintenance ...";
            case "$installDist $name" in
              (*firmwareNetgear*)
                CheckOurOwn /etc/pm/sleep.d/75-prism;
                error "$needsTLC";
                ;;
              (*firmwareBelkin*)
                error "$needsTLC";
                ;;
              (*firmwareRtl*)
                error "$needsTLC";
                ;;
              (*firmwareRadeon*)
                error "$needsTLC";
                ;;
              (*firmwareDvb*)
                  error "$needsTLC";
                ;;
              (*firmwareSdhc*)
                error "$needsTLC";
                ;;
              (*firmwareLblink*)
                CheckOurOwn /etc/pm/sleep.d/75-rtlwifi;
                error "$needsTLC";
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-firmware $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
