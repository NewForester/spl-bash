#!/bin/bash --posix

##
##  Goal:   semi-automate system configuration of local mail
##
##  Use:    source sysconf-mail
##
##  NB:     The caller must source functions etc Ã  la sysconf script.
##

function defineSteps
{
    local major="$1"; shift;
    local minor=0;

    minor=$((minor+1));
    mailInstallMda=$major.$minor;

    minor=$((minor+1));
    mailConfigureMda=$major.$minor;

    minor=$((minor+1));
    mailConfigureMta=$major.$minor;
    mailSatelliteMta=$major.$minor.S;
}

function mailConf
{
    local major="$1"; shift;
    defineSteps $major;

    case "$1" in
      ($major | mail)
        listOptions sysconf-mail "$1";
        quit;
        ;;

      ($mailInstallMda | mailInstallMda)
        step="$mailInstallMda mailInstallMda";
        note "Install dovecot MDA software ...";

        installPackage dovecot-imapd;
        DoOrDie SaveCurrent /etc/{group,passwd};
        ;;

      ($mailConfigureMda | mailConfigureMda)
        step="$mailConfigureMda mailConfigureMda";
        note "Configure dovecot MDA ...";

        if [[ ! -b "/dev/${HOSTNAME}/share_mail" ]]; then
            note "Mail volume does not exist ... bailing";
            quit 1;
        fi

        if ! mountpoint -q "/media/local/mail"; then
            note "Mail volume not a mount point ... bailing";
            quit 1;
        fi

        DoOrDie mkdir -p "/media/local/mail/${USER}";
        DoOrDie sudo mkdir -p "/var/dovecot/indexes/${USER}";
        DoOrDie sudo chown "${USER}" "/var/dovecot/indexes/${USER}";

        DoOrDie InstallOurOwn /etc/dovecot/local.conf;
        DoOrDie sudo service dovecot restart;

        DoOrDie InstallOurOwn /etc/exim4/conf.d/transport/37_exim4-config_dovecot_delivery;
        DoOrDie sudo update-exim4.conf.template --run;
        ;;

      ($mailConfigureMta | mailConfigureMta)
        step="$mailConfigureMta mailConfigureMta";
        note "Configure exim4 MTA as a local MTA ...";

        DoOrDie CopyToKeep /etc/exim4/update-exim4.conf.conf;

        local keep=keep/etc/exim4/update-exim4.conf.conf;
        DoOrDie cp -p "${keep}".$RELEASE "${keep}";
        DoOrDie sed -i "${keep}" -e "\"/dc_other_hostnames=/s/'.*'/'mail.custards.lan ; $HOSTNAME.custards.lan'/\"";
        DoOrDie sed -i "${keep}" -e "\"/dc_local_interfaces=/s/'.*'/'127.0.0.1 ; $(LanAddress) ; ::1'/\"";
        DoOrDie sed -i "${keep}" -e "\"/dc_localdelivery=/s/'.*'/'dovecot_delivery'/\"";

        DoOrDie Deploy /etc/exim4/update-exim4.conf.conf;

        DoOrDie sudo update-exim4.conf;
        DoOrDie sudo service exim4 restart;

        note "Set /etc/aliases to forward e-mail ...";
        DoOrDie CopyToKeep /etc/aliases;
        DoOrDie ApplyPatch /etc/aliases;
        ;;

      ($mailSatelliteMta | mailSatelliteMta)
        step="$mailSatelliteMta mailSatelliteMta";
        note "Configure exim4 as a satellite MTA ...";

        DoOrDie CopyToKeep /etc/exim4/update-exim4.conf.conf;

        local keep=keep/etc/exim4/update-exim4.conf.conf;
        DoOrDie cp -p "${keep}".$RELEASE "${keep}";
        DoOrDie sed -i "${keep}" -e "\"/dc_eximconfig_configtype=/s/'.*'/'satellite'/\"";
        DoOrDie sed -i "${keep}" -e "\"/dc_readhost=/s/'.*'/'$HOSTNAME.custards.lan'/\"";
        DoOrDie sed -i "${keep}" -e "\"/dc_smarthost=/s/'.*'/'mail.custards.lan'/\"";
        DoOrDie sed -i "${keep}" -e "\"/dc_hide_mailname=/s/'.*'/'true'/\"";

        DoOrDie Deploy /etc/exim4/update-exim4.conf.conf;

        DoOrDie sudo update-exim4.conf;
        DoOrDie sudo service exim4 restart;

        note "Set /etc/aliases to forward e-mail ...";
        DoOrDie CopyToKeep /etc/aliases;
        DoOrDie ApplyPatch /etc/aliases;
        ;;

      ($major.99)
        step="$major.99 sanityCheck";
        note "Checking mail ...";
        listLoggedSteps $major | while read step name status; do
            printf "%-7s %-23s %s\n" $step $name $status;
            case "$installDist $name" in
              (*mailInstall)
                CheckCurrent /etc/{group,passwd};
                ;;
              (*mailConfigureMda)
                CheckOurOwn /etc/dovecot/local.conf;
                CheckOurOwn /etc/exim4/conf.d/transport/37_exim4-config_dovecot_delivery;
                ;;
              (*mailConfigureMta)
                CheckOriginal /etc/exim4/update-exim4.conf.conf;
                CheckDeployed /etc/exim4/update-exim4.conf.conf;
                CheckOriginal /etc/aliases;
                CheckPatch /etc/aliases;
                ;;
              (*mailSatelliteMta)
                CheckOriginal /etc/exim4/update-exim4.conf.conf;
                CheckDeployed /etc/exim4/update-exim4.conf.conf;
                CheckOriginal /etc/aliases;
                CheckPatch /etc/aliases;
                ;;

              # old but still needed for checking

              (*mailConfigure)
                CheckOurOwn /etc/dovecot/local.conf;
                CheckOurOwn /etc/exim4/conf.d/transport/37_exim4-config_dovecot_delivery;
                CheckOriginal /etc/exim4/update-exim4.conf.conf;
                CheckDeployed /etc/exim4/update-exim4.conf.conf;
                CheckOriginal /etc/aliases;
                CheckPatch /etc/aliases;
                ;;
              (*mailSatellite)
                CheckOriginal /etc/exim4/update-exim4.conf.conf;
                CheckDeployed /etc/exim4/update-exim4.conf.conf;
                CheckOriginal /etc/aliases;
                CheckPatch /etc/aliases;
                ;;
            esac
        done
        quit;
        ;;

      (*)
        badOption "$1";
        listOptions sysconf-mail $major;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
