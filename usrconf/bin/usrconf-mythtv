#!/bin/bash --posix

##
##  Goal:   semi-automate user configuration of dvb and mythtv
##
##  Use:    source usrconf-mythtv
##
##  NB:     The caller must source functions etc Ã  la usrconf script.
##

# do it

function mythtvConf
{
    local mythtvRoot="/media/work/projects/mythtv/current";
    local tzapDir="${mythtvRoot}/.tzap";
    local mythtvDir="${mythtvRoot}/.mythtv";

    case "$1" in
      (12 | mythtv)
        listOptions 12 mythtv;
        quit;
        ;;

      (12.1 | mythtvUserSetup)
        step="12.1 mythtvUserSetup";
        note "Set up user id for MythTV and DVB project ...";

        echo "... install (shell) scripts";
        DoOrDieLocal updatebin tv;

        echo "... transmitter frequencies";
        if [[ -f "${tzapDir}/uk-Rowridge-DSO" ]]; then
            DoOrDie mkdir -p .tzap;
            DoOrDie cp -p "${tzapDir}/uk-Rowridge-DSO" .tzap;
        fi

        echo "... channel icons";
        if [[ -d "${mythtvDir}/channels" ]]; then
            DoOrDie mkdir -p .mythtv;
            DoOrDie cp -pR "${mythtvDir}/channels" .mythtv;
        fi

        echo "... you may want to change ...";
        echo "    ${mythtvRoot}";
        echo "... before taking further steps";
        ;;

      (12.2 | mythtvDvbCheck)
        step="12.2 mythtvDvbCheck";
        note "Check TV reception (generate channel list) ...";

        echo "... stop mythtv backend (if running)";
        DoOrDieLocal mymythtv stop;

        echo "... scan for channels";
        DoOrDieLocal dvbcheck scan;
        ;;

      (12.3 | mythtvDvbScan)
        step="12.3 mythtvDvbScan";
        note "Do a channel scan and save the results ...";

        echo "... stop mythtv backend (if running)";
        DoOrDieLocal mymythtv stop;

        echo "... scan for channels";
        DoOrDieLocal dvbcheck channels;

        [[ ! -d "${tzapDir}" ]] && DoOrDie cp -pR .tzap "${tzapDir}";

        echo '';
        note 'to test TV reception for real ...';
        echo '... in one tty run';
        echo '        dvbcheck tzap "BBC ONE"';
        echo '... and in another run ...';
        echo '        dvbcheck xine "BBC ONE"';
        ;;

      (12.4 | mythtvSetup)
        step="12.4 mythtvSetup";
        note "Run mythtv setup ...";

        echo "... backup database";
        DoOrDieLocal mymythdb backup;

        if [[ ! -d "${mythtvDir}" ]]; then
            DoOrDie mkdir -p "${mythtvDir}";
            DoOrDie cp -pf .mythtv/mythtv_backup.sql "${mythtvDir}"/mythtv_backup.sql.empty;
            DoOrDie cp -pR .mythtv/channels "${mythtvDir}";
        fi

        echo "... run mythtv setup";
        DoOrDieLocal mymythtv setup;
        ;;

      (12.5 | mythtvRestore)
        step="12.5 mythtvRestore";
        note "Restore MythTV database from the backup ...";

        echo "... restore database";
        DoOrDieLocal mymythdb delete;
        DoOrDieLocal mymythdb create;
        DoOrDieLocal mymythdb restore;

        echo "... run mythtv setup";
        DoOrDieLocal mymythtv setup;
        ;;

      (*)
        badOption "$1";
        listOptions 12 mythtv;
        quit 1;
        ;;
    esac
}

### Local Variables: ***
### mode:ksh ***
### End: ***
